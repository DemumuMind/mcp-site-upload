name: Nightly Smoke

on:
  schedule:
    - cron: "30 3 * * *"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  quality:
    uses: ./.github/workflows/reusable-node-quality.yml
    with:
      runLint: false
      runBuild: false
      runPlaywrightInstall: false
      runAuthE2E: false
      runCatalogHydrationGuard: false

  smoke:
    runs-on: ubuntu-latest
    needs: quality
    timeout-minutes: 15
    env:
      SMOKE_ENABLED: ${{ vars.SMOKE_ENABLED || 'false' }}
      SMOKE_BASE_URL: ${{ vars.SMOKE_BASE_URL }}
      SMOKE_HEALTH_TOKEN: ${{ secrets.SMOKE_HEALTH_TOKEN }}
      SMOKE_ALLOW_PROTECTED: ${{ vars.SMOKE_ALLOW_PROTECTED || 'false' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Resolve smoke execution
        id: resolve_smoke
        shell: bash
        run: |
          if [ "$SMOKE_ENABLED" != "true" ]; then
            echo "Nightly smoke disabled (set SMOKE_ENABLED=true to enable)."
            echo "run_smoke=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if [ -z "$SMOKE_BASE_URL" ]; then
            echo "Repository variable SMOKE_BASE_URL is required."
            exit 1
          fi
          echo "run_smoke=true" >> "$GITHUB_OUTPUT"

      - name: Run smoke check
        if: ${{ steps.resolve_smoke.outputs.run_smoke == 'true' }}
        run: npm run smoke:check -- "$SMOKE_BASE_URL"

      - name: Remote backup artifact check
        if: ${{ vars.BACKUP_REMOTE_CHECK_ENABLED == 'true' }}
        env:
          BACKUP_REMOTE_CHECK_URL: ${{ vars.BACKUP_REMOTE_CHECK_URL }}
          BACKUP_REMOTE_CHECK_METHOD: ${{ vars.BACKUP_REMOTE_CHECK_METHOD || 'auto' }}
          BACKUP_REMOTE_S3_REGION: ${{ vars.BACKUP_REMOTE_S3_REGION || 'us-east-1' }}
          BACKUP_REMOTE_AUTH_HEADER: ${{ secrets.BACKUP_REMOTE_AUTH_HEADER }}
          BACKUP_REMOTE_BEARER_TOKEN: ${{ secrets.BACKUP_REMOTE_BEARER_TOKEN }}
          BACKUP_MAX_AGE_HOURS: ${{ vars.BACKUP_MAX_AGE_HOURS || '26' }}
        run: npm run ops:backup-verify-remote

      - name: Smoke disabled summary
        if: ${{ steps.resolve_smoke.outputs.run_smoke != 'true' }}
        run: echo "Nightly smoke is disabled by SMOKE_ENABLED=false."
