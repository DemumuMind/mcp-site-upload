name: Catalog Automation Status

on:
  schedule:
    - cron: "20 */2 * * *"
  workflow_dispatch:

jobs:
  check-catalog-automation:
    runs-on: ubuntu-latest
    steps:
      - name: Check /api/catalog/automation-status
        env:
          BASE_URL: ${{ vars.SMOKE_BASE_URL || 'https://mcp-site-silk.vercel.app' }}
          CATALOG_AUTOSYNC_CRON_SECRET: ${{ secrets.CATALOG_AUTOSYNC_CRON_SECRET }}
        run: |
          set -euo pipefail
          if [ -z "${CATALOG_AUTOSYNC_CRON_SECRET:-}" ]; then
            echo "Missing CATALOG_AUTOSYNC_CRON_SECRET secret"
            exit 1
          fi
          URL="${BASE_URL%/}/api/catalog/automation-status"
          echo "Checking $URL"
          RESPONSE=$(curl -fsSL "$URL" -H "Authorization: Bearer $CATALOG_AUTOSYNC_CRON_SECRET")
          echo "$RESPONSE" > response.json
          node -e "const fs=require('fs'); const r=JSON.parse(fs.readFileSync('response.json','utf8')); const checks=r.checks||{}; const pass=Boolean(r.ok)&&Boolean(checks.cronConfigured)&&Boolean(checks.secretConfigured)&&Boolean(checks.runtimeReady); console.log('ok=',r.ok,'checks=',checks); if(!pass){console.error('Catalog automation status failed'); process.exit(1);}"
